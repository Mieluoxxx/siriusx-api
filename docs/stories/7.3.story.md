# Story 7.3: 供应商管理页面

**Epic**: Epic 7 - Web 管理界面
**Story ID**: 7.3
**Story Title**: 供应商管理页面
**Status**: Done
**估算工时**: 2 天 (16 小时)
**优先级**: P1 (SHOULD HAVE)
**创建日期**: 2025-10-02
**完成日期**: 2025-10-02

---

## Story Statement

**作为** 系统管理员
**我想要** 通过 Web 界面管理供应商配置
**以便于** 快速添加、编辑、删除供应商，无需手动修改配置文件

---

## 需求背景 (Epic 7)

根据 PRD Epic 7 的规划，供应商管理页面需要提供完整的 CRUD 功能，支持健康检查、启用/禁用等操作。

---

## 任务清单

### AC1: 创建供应商管理页面
- [x] 创建 `src/pages/providers.astro`
- [x] 创建 `src/components/ProviderManagement.tsx`
- [x] 实现页面路由和导航

### AC2: 供应商列表表格
- [x] 实现表格组件 (使用 UI 库)
- [x] 显示列：ID、名称、Base URL、健康状态、操作
- [x] 实现分页功能 (如需要)
- [x] 实现排序功能 (如需要)

### AC3: 添加供应商功能
- [x] 实现添加供应商对话框
- [x] 表单字段：名称、类型、Base URL、API Key
- [x] 表单验证 (非空验证、URL 格式验证)
- [x] 调用 `POST /api/providers` 创建供应商
- [x] 显示成功/失败提示

### AC4: 编辑供应商功能
- [x] 实现编辑供应商对话框
- [x] 预填充现有数据
- [x] 支持修改所有字段
- [x] 调用 `PUT /api/providers/:id` 更新供应商
- [x] 显示成功/失败提示

### AC5: 删除供应商功能
- [x] 实现删除确认对话框
- [x] 显示警告信息
- [x] 调用 `DELETE /api/providers/:id` 删除供应商
- [x] 删除后刷新列表

### AC6: 健康检查功能
- [x] 实现手动健康检查按钮
- [x] 调用 `POST /api/providers/:id/health-check`
- [x] 实时更新健康状态
- [x] 显示健康状态图标 (绿色/红色)

### AC7: 启用/禁用功能
- [x] 实现启用/禁用开关
- [x] 调用 API 更新状态
- [x] 实时更新 UI

### AC8: API Key 安全处理
- [x] API Key 脱敏显示 (`sk-****1234`)
- [x] 编辑时支持修改 API Key
- [x] 不回显完整 API Key

### AC9: 交互优化
- [x] 所有操作显示 Loading 状态
- [x] 操作成功/失败显示 Toast 提示
- [x] 表单验证错误提示
- [x] 响应式布局

---

## 验收标准

### 1. CRUD 功能完整
- [x] 可以创建供应商
- [x] 可以查看供应商列表
- [x] 可以编辑供应商信息
- [x] 可以删除供应商

### 2. 表单验证正确
- [x] 名称非空验证
- [x] Base URL 格式验证
- [x] API Key 非空验证
- [x] 验证错误显示清晰的错误消息

### 3. 健康状态功能
- [x] 健康状态实时更新
- [x] 绿色图标表示健康
- [x] 红色图标表示不健康
- [x] 手动健康检查功能正常

### 4. API Key 安全
- [x] 列表中 API Key 脱敏显示
- [x] 编辑时不回显完整 Key
- [x] 支持更新 API Key

### 5. 性能要求
- [x] 所有 CRUD 操作响应 < 500ms
- [x] UI 响应流畅
- [x] 表格渲染性能良好

### 6. 用户体验
- [x] 操作成功/失败有 Toast 提示
- [x] 危险操作有确认对话框
- [x] Loading 状态提示明确
- [x] 错误消息清晰易懂

---

## 技术细节

### 组件结构
```
ProviderManagement.tsx
├── ProviderTable          # 供应商列表表格
│   ├── TableHeader
│   ├── TableRow
│   └── ActionButtons
├── AddProviderDialog      # 添加供应商对话框
├── EditProviderDialog     # 编辑供应商对话框
└── DeleteConfirmDialog    # 删除确认对话框
```

### API 调用
```typescript
// 获取供应商列表
GET /api/providers

// 创建供应商
POST /api/providers
Body: {
  name: string,
  type: string,
  base_url: string,
  api_key: string
}

// 更新供应商
PUT /api/providers/:id
Body: { /* 同上 */ }

// 删除供应商
DELETE /api/providers/:id

// 健康检查
POST /api/providers/:id/health-check
```

### 表单验证规则
```typescript
const validationSchema = {
  name: {
    required: "供应商名称不能为空",
    minLength: { value: 2, message: "名称至少 2 个字符" }
  },
  base_url: {
    required: "Base URL 不能为空",
    pattern: {
      value: /^https?:\/\/.+/,
      message: "请输入有效的 URL"
    }
  },
  api_key: {
    required: "API Key 不能为空",
    minLength: { value: 10, message: "API Key 长度不足" }
  }
}
```

### API Key 脱敏逻辑
```typescript
function maskApiKey(key: string): string {
  if (key.length <= 8) return '****';
  const prefix = key.substring(0, 4);
  const suffix = key.substring(key.length - 4);
  return `${prefix}****${suffix}`;
}
```

---

## 实现状态

✅ **已完成** - 供应商管理页面已完整实现，所有 CRUD 功能正常工作

### 实现文件
- `web/src/pages/providers.astro` - 供应商管理页面入口
- `web/src/components/ProviderManagement.tsx` - 供应商管理主组件

### 实现的功能
1. ✅ 供应商列表展示
2. ✅ 创建供应商 (带表单验证)
3. ✅ 编辑供应商
4. ✅ 删除供应商 (带确认对话框)
5. ✅ 健康检查功能
6. ✅ API Key 脱敏显示
7. ✅ Toast 提示
8. ✅ 响应式布局

### Git Commit
- `cb5969b` - feat: 实现 Web 管理界面 (Epic 7)
- `4e67145` - feat: 完善后端 API 以支持前端管理界面 (Epic 7)

---

## 界面设计

### 页面布局
```
┌─────────────────────────────────────────┐
│  Providers Management                   │
│  [+ Add Provider]                       │
├─────────────────────────────────────────┤
│  Name  │ Base URL │ API Key │ Status │ Actions │
├────────┼──────────┼─────────┼────────┼─────────┤
│ OneAPI │ https:// │ sk-***  │   ✅   │ 🔧 ❌  │
│ Azure  │ https:// │ sk-***  │   ❌   │ 🔧 ❌  │
└─────────────────────────────────────────┘
```

### 添加/编辑对话框
```
┌─────────────────────────────────┐
│  Add Provider            [x]    │
├─────────────────────────────────┤
│  Name: [____________]           │
│  Type: [____________]           │
│  Base URL: [____________]       │
│  API Key: [____________]        │
│                                 │
│        [Cancel]  [Save]         │
└─────────────────────────────────┘
```

---

## 相关文档

- [PRD - Epic 7: Web 管理界面](../prd.md#epic-7-web-管理界面-fr20-fr24-fr6)
- [Story 7.1 - 搭建 Astro + React 项目](./7.1.story.md)
- [Story 3.1 - 供应商 CRUD API](./3.1.story.md)
- [API 文档 - Provider Endpoints](../api/openapi.yaml)
