# Story 5.3: æ™ºèƒ½æ•…éšœè½¬ç§»

> **Epic 5**: è´Ÿè½½å‡è¡¡ä¸æ•…éšœè½¬ç§» (FR11-FR14)
> **Story**: 5.3 - æ™ºèƒ½æ•…éšœè½¬ç§»
> **ä¼˜å…ˆçº§**: P0 (MUST HAVE)
> **ä¼°ç®—**: 1.5 å¤©

---

## 1. éœ€æ±‚æ¦‚è¿°

æ ¹æ® PRD éœ€æ±‚ FR13-FR14,å®ç°æ™ºèƒ½æ•…éšœè½¬ç§»æœºåˆ¶:

### FR13: è‡ªåŠ¨æ•…éšœè½¬ç§»

**æµç¨‹**:
1. æŒ‰ä¼˜å…ˆçº§æ’åºæ‰€æœ‰æ˜ å°„
2. å°è¯•ä¼˜å…ˆçº§æœ€é«˜çš„ä¾›åº”å•†
3. å¦‚æœå¤±è´¥ä¸”æ»¡è¶³æ•…éšœæ¡ä»¶ â†’ å°è¯•ä¸‹ä¸€ä¸ª
4. æœ€å¤šé‡è¯• N æ¬¡ (é»˜è®¤ 3 æ¬¡,å¯é…ç½®)
5. æ‰€æœ‰ä¾›åº”å•†éƒ½å¤±è´¥ â†’ è¿”å›æœ€åä¸€ä¸ªé”™è¯¯

**ç¤ºä¾‹**:
```
ç»Ÿä¸€æ¨¡å‹: claude-sonnet-4
â”œâ”€â”€ ä¾›åº”å•† A (ä¼˜å…ˆçº§: 1) â†’ è¶…æ—¶ â†’ æ•…éšœè½¬ç§»
â”œâ”€â”€ ä¾›åº”å•† B (ä¼˜å…ˆçº§: 2) â†’ æˆåŠŸ âœ“
â””â”€â”€ ä¾›åº”å•† C (ä¼˜å…ˆçº§: 3) â†’ (æœªä½¿ç”¨)
```

### FR14: æ•…éšœæ¢å¤

**æœºåˆ¶**:
- é€šè¿‡å¥åº·æ£€æŸ¥æ¢å¤æ ‡è®°ä¸º"ä¸å¯ç”¨"çš„ä¾›åº”å•†
- æˆ–è®¾ç½®è¶…æ—¶ (5 åˆ†é’Ÿåè‡ªåŠ¨æ¢å¤)

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ•…éšœè½¬ç§»æˆåŠŸç‡ > 95%
- [ ] é‡è¯•æ¬¡æ•°ä¸è¶…è¿‡ 3 æ¬¡
- [ ] æ•…éšœè½¬ç§»å»¶è¿Ÿ < 5s
- [ ] é›†æˆæµ‹è¯•: ä¸»ä¾›åº”å•†æ•…éšœåœºæ™¯
- [ ] æ—¥å¿—è®°å½•å®Œæ•´ (åŒ…å«æ•…éšœåŸå› )

---

## 2. æŠ€æœ¯è®¾è®¡

### 2.1 æ•°æ®ç»“æ„

```go
// FailoverExecutor æ•…éšœè½¬ç§»æ‰§è¡Œå™¨
type FailoverExecutor struct {
    balancer         LoadBalancer
    failureDetector  FailureDetector
    config           *FailoverConfig
}

// FailoverConfig æ•…éšœè½¬ç§»é…ç½®
type FailoverConfig struct {
    MaxRetries       int           // æœ€å¤§é‡è¯•æ¬¡æ•°,é»˜è®¤ 3
    EnableFailover   bool          // æ˜¯å¦å¯ç”¨æ•…éšœè½¬ç§»,é»˜è®¤ true
}

// FailoverResult æ•…éšœè½¬ç§»ç»“æœ
type FailoverResult struct {
    SelectedProvider *mapping.ResolvedMapping  // æˆåŠŸçš„ä¾›åº”å•†æ˜ å°„
    AttemptCount     int                       // å°è¯•æ¬¡æ•°
    FailedProviders  []FailureAttempt          // å¤±è´¥çš„ä¾›åº”å•†åˆ—è¡¨
}

// FailureAttempt æ•…éšœè½¬ç§»å°è¯•è®°å½•
type FailureAttempt struct {
    ProviderID       uint          // ä¾›åº”å•† ID
    TargetModel      string        // ç›®æ ‡æ¨¡å‹
    FailureType      FailureType   // æ•…éšœç±»å‹
    Error            error         // é”™è¯¯ä¿¡æ¯
}
```

### 2.2 æ ¸å¿ƒç®—æ³•

#### æ•…éšœè½¬ç§»æµç¨‹

```go
func (f *FailoverExecutor) SelectProviderWithFailover(
    mappings []*mapping.ResolvedMapping,
) (*FailoverResult, error) {

    if len(mappings) == 0 {
        return nil, errors.New("no available providers")
    }

    // 1. æŒ‰ä¼˜å…ˆçº§æ’åº (Priority ä»å°åˆ°å¤§)
    sortedMappings := f.sortByPriority(mappings)

    result := &FailoverResult{
        FailedProviders: []FailureAttempt{},
    }

    // 2. æŒ‰ä¼˜å…ˆçº§é¡ºåºå°è¯•æ¯ä¸ªä¾›åº”å•†
    for i, mapping := range sortedMappings {
        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é‡è¯•æ¬¡æ•°
        if i >= f.config.MaxRetries {
            break
        }

        // æ£€æŸ¥ä¾›åº”å•†æ˜¯å¦å¯ç”¨ (æœªåœ¨å†·å´æœŸ)
        if !f.failureDetector.IsAvailable(mapping.ProviderID) {
            result.FailedProviders = append(result.FailedProviders, FailureAttempt{
                ProviderID:  mapping.ProviderID,
                TargetModel: mapping.TargetModel,
                FailureType: FailureTypeCooldown,
                Error:       errors.New("provider in cooldown period"),
            })
            result.AttemptCount++
            continue
        }

        // 3. é€‰æ‹©è¯¥ä¾›åº”å•†
        result.SelectedProvider = mapping
        result.AttemptCount++
        return result, nil
    }

    // 4. æ‰€æœ‰ä¾›åº”å•†éƒ½ä¸å¯ç”¨
    return result, errors.New("all providers unavailable or in cooldown")
}
```

#### ä¼˜å…ˆçº§æ’åº

```go
func (f *FailoverExecutor) sortByPriority(
    mappings []*mapping.ResolvedMapping,
) []*mapping.ResolvedMapping {
    sorted := make([]*mapping.ResolvedMapping, len(mappings))
    copy(sorted, mappings)

    sort.Slice(sorted, func(i, j int) bool {
        return sorted[i].Priority < sorted[j].Priority
    })

    return sorted
}
```

---

## 3. é›†æˆè®¾è®¡

### 3.1 ä¸è´Ÿè½½å‡è¡¡å™¨é›†æˆ

```go
// è´Ÿè½½å‡è¡¡ + æ•…éšœè½¬ç§»çš„å®Œæ•´æµç¨‹
func SelectProviderIntelligent(
    mappings []*mapping.ResolvedMapping,
    balancer LoadBalancer,
    failover *FailoverExecutor,
) (*mapping.ResolvedMapping, error) {

    // 1. å…ˆä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©
    selected := balancer.SelectProvider(mappings)
    if selected != nil && failover.failureDetector.IsAvailable(selected.ProviderID) {
        return selected, nil
    }

    // 2. å¦‚æœè´Ÿè½½å‡è¡¡é€‰æ‹©çš„ä¾›åº”å•†ä¸å¯ç”¨,ä½¿ç”¨æ•…éšœè½¬ç§»
    result, err := failover.SelectProviderWithFailover(mappings)
    if err != nil {
        return nil, err
    }

    return result.SelectedProvider, nil
}
```

### 3.2 ä¸æ•…éšœæ£€æµ‹å™¨é›†æˆ

æ•…éšœè½¬ç§»æ‰§è¡Œå™¨ä¾èµ–æ•…éšœæ£€æµ‹å™¨çš„ä»¥ä¸‹åŠŸèƒ½:
- `IsAvailable(providerID uint) bool`: æ£€æŸ¥ä¾›åº”å•†æ˜¯å¦å¯ç”¨
- `RecordFailure(providerID uint, failureType FailureType)`: è®°å½•æ•…éšœ
- `RecordSuccess(providerID uint)`: è®°å½•æˆåŠŸ

---

## 4. æµ‹è¯•ç­–ç•¥

### 4.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**:

1. **åŸºç¡€æ•…éšœè½¬ç§» - ç¬¬ä¸€ä¸ªä¾›åº”å•†å¯ç”¨**
   - 3 ä¸ªä¾›åº”å•†,å…¨éƒ¨å¯ç”¨
   - éªŒè¯é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ (Priority = 1)

2. **æ•…éšœè½¬ç§» - ç¬¬ä¸€ä¸ªä¾›åº”å•†ä¸å¯ç”¨**
   - 3 ä¸ªä¾›åº”å•†,ç¬¬ä¸€ä¸ªåœ¨å†·å´æœŸ
   - éªŒè¯é€‰æ‹©ç¬¬äºŒä¸ªä¾›åº”å•† (Priority = 2)

3. **å¤šæ¬¡æ•…éšœè½¬ç§»**
   - 3 ä¸ªä¾›åº”å•†,å‰ä¸¤ä¸ªä¸å¯ç”¨
   - éªŒè¯é€‰æ‹©ç¬¬ä¸‰ä¸ªä¾›åº”å•† (Priority = 3)

4. **é‡è¯•æ¬¡æ•°é™åˆ¶**
   - 5 ä¸ªä¾›åº”å•†,é…ç½® MaxRetries = 3
   - å…¨éƒ¨ä¸å¯ç”¨
   - éªŒè¯åªå°è¯•äº†å‰ 3 ä¸ª

5. **å…¨éƒ¨ä¾›åº”å•†ä¸å¯ç”¨**
   - 3 ä¸ªä¾›åº”å•†,å…¨éƒ¨åœ¨å†·å´æœŸ
   - éªŒè¯è¿”å›é”™è¯¯

6. **ä¼˜å…ˆçº§æ’åºæ­£ç¡®æ€§**
   - æä¾›ä¹±åºçš„æ˜ å°„åˆ—è¡¨ (Priority: 3, 1, 2)
   - éªŒè¯æŒ‰ 1, 2, 3 é¡ºåºå°è¯•

### 4.2 åœºæ™¯æµ‹è¯•

**æµ‹è¯•åœºæ™¯**:

1. **çœŸå®æ•…éšœè½¬ç§»æµç¨‹**
   - æ¨¡æ‹Ÿä¸»ä¾›åº”å•†æ•…éšœ (å†·å´æœŸ 100ms)
   - è°ƒç”¨æ•…éšœè½¬ç§»
   - éªŒè¯é€‰æ‹©å¤‡ç”¨ä¾›åº”å•†
   - ç­‰å¾…å†·å´æœŸç»“æŸ
   - éªŒè¯ä¸»ä¾›åº”å•†æ¢å¤

2. **ä¸è´Ÿè½½å‡è¡¡å™¨ååŒ**
   - è´Ÿè½½å‡è¡¡é€‰ä¸­ä¾›åº”å•† A
   - ä¾›åº”å•† A åœ¨å†·å´æœŸ
   - æ•…éšœè½¬ç§»åˆ°ä¾›åº”å•† B
   - éªŒè¯æœ€ç»ˆé€‰æ‹© B

3. **é«˜å¹¶å‘åœºæ™¯**
   - 50 ä¸ª goroutine åŒæ—¶è¯·æ±‚æ•…éšœè½¬ç§»
   - éªŒè¯å¹¶å‘å®‰å…¨
   - éªŒè¯æ•…éšœè®¡æ•°æ­£ç¡®

---

## 5. æ€§èƒ½è¦æ±‚

### 5.1 å»¶è¿Ÿè¦æ±‚

- **æ— æ•…éšœè½¬ç§»åœºæ™¯** (ç¬¬ä¸€ä¸ªä¾›åº”å•†ç›´æ¥å¯ç”¨):
  - å»¶è¿Ÿ < 1ms

- **å•æ¬¡æ•…éšœè½¬ç§»** (åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªä¾›åº”å•†):
  - é¢å¤–å»¶è¿Ÿ < 10ms

- **å¤šæ¬¡æ•…éšœè½¬ç§»** (æœ€å¤š 3 æ¬¡):
  - æ€»å»¶è¿Ÿ < 30ms

### 5.2 å¹¶å‘æ€§èƒ½

- æ”¯æŒ 100+ å¹¶å‘è¯·æ±‚
- æ— ç«æ€æ¡ä»¶
- æ— æ­»é”

---

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶

- [ ] **æ•…éšœè½¬ç§»æˆåŠŸç‡ > 95%**
  - è‡³å°‘æœ‰ 1 ä¸ªå¯ç”¨ä¾›åº”å•†æ—¶,æˆåŠŸé€‰æ‹©
  - æµ‹è¯• 1000 æ¬¡,æˆåŠŸç‡ > 95%

- [ ] **ä¼˜å…ˆçº§æ’åºæ­£ç¡®**
  - å§‹ç»ˆæŒ‰ Priority ä»å°åˆ°å¤§å°è¯•

- [ ] **é‡è¯•æ¬¡æ•°é™åˆ¶æ­£ç¡®**
  - ä¸è¶…è¿‡ MaxRetries é…ç½®å€¼

- [ ] **å†·å´æœŸæœºåˆ¶æ­£å¸¸**
  - å¤„äºå†·å´æœŸçš„ä¾›åº”å•†è¢«è·³è¿‡
  - å†·å´æœŸç»“æŸåè‡ªåŠ¨æ¢å¤

### 6.2 æ€§èƒ½éªŒæ”¶

- [ ] **å»¶è¿Ÿç¬¦åˆè¦æ±‚**
  - æ— æ•…éšœè½¬ç§» < 1ms
  - å•æ¬¡æ•…éšœè½¬ç§» < 10ms

- [ ] **å¹¶å‘å®‰å…¨**
  - é€šè¿‡ race detector æ£€æµ‹
  - 100 å¹¶å‘æ— é—®é¢˜

### 6.3 ä»£ç è´¨é‡

- [ ] **å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90%**
- [ ] **åœºæ™¯æµ‹è¯•è¦†ç›–æ‰€æœ‰å…³é”®æµç¨‹**
- [ ] **ä»£ç ç¬¦åˆ Go æœ€ä½³å®è·µ**

---

## 7. å®ç°æ¸…å•

### 7.1 ä»£ç å®ç°

- [ ] åˆ›å»º `internal/balancer/failover.go`
- [ ] å®ç° `FailoverExecutor` ç»“æ„ä½“
- [ ] å®ç° `SelectProviderWithFailover()` æ–¹æ³•
- [ ] å®ç° `sortByPriority()` è¾…åŠ©æ–¹æ³•
- [ ] å®ç° `SelectProviderIntelligent()` é›†æˆå‡½æ•°

### 7.2 æµ‹è¯•å®ç°

- [ ] åˆ›å»º `internal/balancer/failover_test.go`
- [ ] å®ç° 6 ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹
- [ ] åˆ›å»º `internal/balancer/failover_scenario_test.go`
- [ ] å®ç° 3 ä¸ªåœºæ™¯æµ‹è¯•

### 7.3 æ–‡æ¡£æ›´æ–°

- [ ] æ›´æ–°æœ¬ Story æ–‡æ¡£æ ‡è®°å®ŒæˆçŠ¶æ€

---

## 8. ä¾èµ–å…³ç³»

### 8.1 ä¾èµ–æ¨¡å—

- **Story 5.1 (åŠ æƒéšæœºè´Ÿè½½å‡è¡¡å™¨)**:
  - ä½¿ç”¨ `LoadBalancer` æ¥å£
  - ä¸è´Ÿè½½å‡è¡¡å™¨ååŒå·¥ä½œ

- **Story 5.2 (æ•…éšœæ£€æµ‹é€»è¾‘)**:
  - ä½¿ç”¨ `FailureDetector` æ¥å£
  - ä¾èµ– `IsAvailable()` åˆ¤æ–­å¯ç”¨æ€§
  - ä¾èµ–å†·å´æœŸæœºåˆ¶

- **Story 4.3 (è·¯ç”±è§£æé€»è¾‘)**:
  - ä¾èµ– `ResolvedMapping` æ•°æ®ç»“æ„
  - ä¾èµ– Priority å­—æ®µ

---

## 9. å‚è€ƒèµ„æ–™

- [PRD - Epic 5: è´Ÿè½½å‡è¡¡ä¸æ•…éšœè½¬ç§»](../prd.md#epic-5-è´Ÿè½½å‡è¡¡ä¸æ•…éšœè½¬ç§»-fr11-fr14)
- [Story 5.1 - åŠ æƒéšæœºè´Ÿè½½å‡è¡¡å™¨](./5.1.story.md)
- [Story 5.2 - æ•…éšœæ£€æµ‹é€»è¾‘](./5.2.story.md)

---

**Story çŠ¶æ€**: ğŸ“ è®¾è®¡å®Œæˆ,å¾…å®ç°
**åˆ›å»ºæ—¶é—´**: 2025-10-02
