# Story 7.4: 模型配置页面

**Epic**: Epic 7 - Web 管理界面
**Story ID**: 7.4
**Story Title**: 模型配置页面
**Status**: Done
**估算工时**: 2 天 (16 小时)
**优先级**: P1 (SHOULD HAVE)
**创建日期**: 2025-10-02
**完成日期**: 2025-10-02

---

## Story Statement

**作为** 系统管理员
**我想要** 通过 Web 界面管理模型映射配置
**以便于** 快速配置统一模型名称到供应商的映射关系，支持负载均衡和故障转移

---

## 需求背景 (Epic 7)

根据 PRD Epic 7 的规划，模型配置页面需要提供统一模型管理和映射配置功能，支持权重设置、优先级管理和可视化展示。

---

## 任务清单

### AC1: 创建模型配置页面
- [x] 创建 `src/pages/models.astro`
- [x] 创建 `src/components/ModelManagement.tsx`
- [x] 实现页面路由和导航

### AC2: 统一模型列表
- [x] 实现模型列表组件
- [x] 显示列：模型名称、映射数量、操作
- [x] 实现模型搜索/过滤功能
- [x] 支持模型排序

### AC3: 创建/编辑统一模型
- [x] 实现创建模型对话框
- [x] 表单字段：模型名称、描述
- [x] 表单验证 (名称唯一性、格式验证)
- [x] 调用 `POST /api/models` 创建模型
- [x] 调用 `PUT /api/models/:id` 更新模型

### AC4: 映射配置区域
- [x] 实现映射列表展示 (嵌套表格或卡片)
- [x] 显示：供应商、目标模型、权重、优先级
- [x] 支持展开/折叠映射详情
- [x] 实时显示映射统计

### AC5: 添加/编辑映射
- [x] 实现添加映射对话框
- [x] 表单字段：选择供应商、目标模型名称、权重、优先级
- [x] 供应商下拉选择器 (从 API 获取)
- [x] 权重滑块 (1-100)
- [x] 优先级输入框
- [x] 调用 `POST /api/models/:id/mappings` 添加映射
- [x] 调用 `PUT /api/mappings/:id` 更新映射

### AC6: 删除映射
- [x] 实现删除映射确认对话框
- [x] 调用 `DELETE /api/mappings/:id` 删除映射
- [x] 删除后刷新列表

### AC7: 辅助功能
- [x] 权重总和实时计算和提示
- [x] 优先级冲突检测 (高亮显示)
- [x] 映射验证 (确保配置合理)
- [x] 批量操作 (如需要)

### AC8: 映射可视化 (可选)
- [ ] 实现映射关系图 (Mermaid 或树形结构)
- [ ] 直观展示路由关系
- [ ] 支持交互式查看

### AC9: 交互优化
- [x] 所有操作显示 Loading 状态
- [x] 操作成功/失败显示 Toast 提示
- [x] 表单验证错误提示
- [x] 响应式布局

---

## 验收标准

### 1. 模型管理功能
- [x] 可以创建统一模型
- [x] 可以查看模型列表
- [x] 可以编辑模型信息
- [x] 可以删除模型 (需确认)

### 2. 映射配置功能
- [x] 可以为模型添加映射
- [x] 可以编辑映射配置
- [x] 可以删除映射
- [x] 映射列表展示清晰

### 3. 权重管理
- [x] 权重滑块实时更新 (1-100)
- [x] 权重总和实时计算
- [x] 权重总和提示准确
- [x] 支持精确权重输入

### 4. 优先级管理
- [x] 支持设置映射优先级
- [x] 优先级冲突时显示警告
- [x] 优先级排序清晰
- [ ] 支持拖拽排序 (可选)

### 5. 表单验证
- [x] 模型名称唯一性验证
- [x] 供应商选择必填
- [x] 目标模型名称非空
- [x] 权重范围验证 (1-100)

### 6. 用户体验
- [x] 操作响应 < 500ms
- [x] Toast 提示清晰
- [x] 映射统计信息准确
- [x] 响应式布局良好

---

## 技术细节

### 组件结构
```
ModelManagement.tsx
├── ModelList              # 统一模型列表
│   ├── ModelCard
│   └── MappingList
├── CreateModelDialog      # 创建模型对话框
├── EditModelDialog        # 编辑模型对话框
├── AddMappingDialog       # 添加映射对话框
│   ├── ProviderSelector
│   ├── WeightSlider
│   └── PriorityInput
├── EditMappingDialog      # 编辑映射对话框
└── DeleteConfirmDialog    # 删除确认对话框
```

### API 调用
```typescript
// 获取模型列表
GET /api/models

// 创建模型
POST /api/models
Body: {
  name: string,
  description?: string
}

// 添加映射
POST /api/models/:id/mappings
Body: {
  provider_id: number,
  target_model: string,
  weight: number,
  priority: number
}

// 更新映射
PUT /api/mappings/:id
Body: { /* 同上 */ }

// 删除映射
DELETE /api/mappings/:id
```

### 权重总和计算
```typescript
function calculateWeightSum(mappings: Mapping[]): number {
  return mappings.reduce((sum, m) => sum + m.weight, 0);
}

function validateWeights(mappings: Mapping[]): boolean {
  const sum = calculateWeightSum(mappings);
  return sum === 100;
}
```

### 优先级冲突检测
```typescript
function detectPriorityConflict(mappings: Mapping[]): boolean {
  const priorities = mappings.map(m => m.priority);
  const uniquePriorities = new Set(priorities);
  return priorities.length !== uniquePriorities.size;
}
```

---

## 实现状态

✅ **已完成** - 模型配置页面已完整实现，核心功能正常工作

### 实现文件
- `web/src/pages/models.astro` - 模型配置页面入口
- `web/src/components/ModelManagement.tsx` - 模型管理主组件

### 实现的功能
1. ✅ 统一模型列表展示
2. ✅ 创建/编辑模型
3. ✅ 添加/编辑映射配置
4. ✅ 删除映射 (带确认)
5. ✅ 权重滑块和实时计算
6. ✅ 优先级设置
7. ✅ Toast 提示
8. ✅ 响应式布局

### 未实现的功能 (可选)
- ⏳ 映射可视化 (Mermaid 图或树形结构)
- ⏳ 优先级拖拽排序

### Git Commit
- `cb5969b` - feat: 实现 Web 管理界面 (Epic 7)
- `4e67145` - feat: 完善后端 API 以支持前端管理界面 (Epic 7)

---

## 界面设计

### 页面布局
```
┌─────────────────────────────────────────┐
│  Model Management                       │
│  [+ Add Model]                          │
├─────────────────────────────────────────┤
│  📦 claude-sonnet-4                     │
│     Mappings: 2                         │
│     ├─ OneAPI (gpt-4o) - W:70, P:1     │
│     └─ Azure (gpt-4o-deployment) - W:30, P:2 │
│     [+ Add Mapping] [Edit] [Delete]    │
│                                         │
│  📦 claude-opus-4                       │
│     Mappings: 1                         │
│     └─ OneAPI (gpt-4) - W:100, P:1     │
│     [+ Add Mapping] [Edit] [Delete]    │
└─────────────────────────────────────────┘
```

### 添加映射对话框
```
┌─────────────────────────────────┐
│  Add Mapping             [x]    │
├─────────────────────────────────┤
│  Provider: [OneAPI ▼]           │
│  Target Model: [____________]   │
│  Weight: [=========>    ] 70    │
│  Priority: [1]                  │
│                                 │
│  ⚠️ Weight sum: 70/100          │
│                                 │
│        [Cancel]  [Add]          │
└─────────────────────────────────┘
```

---

## 相关文档

- [PRD - Epic 7: Web 管理界面](../prd.md#epic-7-web-管理界面-fr20-fr24-fr6)
- [Story 7.1 - 搭建 Astro + React 项目](./7.1.story.md)
- [Story 4.1 - 统一模型管理](./4.1.story.md)
- [Story 4.2 - 模型映射配置](./4.2.story.md)
- [API 文档 - Model Endpoints](../api/openapi.yaml)
