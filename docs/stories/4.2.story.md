# Story 4.2: 模型映射配置

**Epic**: Epic 4 - 模型映射与路由
**Priority**: P0 (MUST HAVE)
**Estimate**: 1 天
**Status**: 待开始 ⏳

---

## Story Description

**作为** 系统管理员
**我想要** 将统一模型映射到具体供应商的模型
**以便于** 实现负载均衡和故障转移，通过多个供应商提供同一个统一模型服务

---

## Acceptance Criteria

### AC1: 映射 CRUD 操作
- [ ] 支持为模型添加映射 (`POST /api/models/:id/mappings`)
- [ ] 支持查询模型的所有映射 (`GET /api/models/:id/mappings`)
- [ ] 支持更新映射配置 (`PUT /api/mappings/:id`)
- [ ] 支持删除映射 (`DELETE /api/mappings/:id`)

### AC2: 映射字段验证
- [ ] `provider_id` 必须存在且有效
- [ ] `target_model` 不能为空
- [ ] `weight` 范围必须在 1-100 之间
- [ ] `priority` 必须为正整数，同一模型下不能重复
- [ ] `enabled` 字段必须为布尔值

### AC3: 业务规则验证
- [ ] 一个统一模型可以映射到多个供应商
- [ ] 同一个统一模型不能重复映射到同一个供应商的同一个目标模型
- [ ] 删除供应商时应该级联删除相关映射
- [ ] 删除统一模型时应该级联删除相关映射

### AC4: 性能要求
- [ ] API 响应延迟 < 50ms
- [ ] 支持分页查询映射（可选参数）
- [ ] 数据库查询优化（使用合适的索引）

### AC5: 测试覆盖
- [ ] 单元测试覆盖率 > 80%
- [ ] Repository 层完整测试
- [ ] Service 层业务逻辑测试
- [ ] Handler 层 API 集成测试

---

## Technical Design

### 1. 数据库设计

#### ModelMapping 数据模型

```go
type ModelMapping struct {
    ID           uint      `gorm:"primaryKey" json:"id"`
    UnifiedModelID uint    `gorm:"not null;index" json:"unified_model_id"`
    ProviderID   uint      `gorm:"not null;index" json:"provider_id"`
    TargetModel  string    `gorm:"type:varchar(100);not null" json:"target_model"`
    Weight       int       `gorm:"not null;default:50;check:weight >= 1 AND weight <= 100" json:"weight"`
    Priority     int       `gorm:"not null;check:priority >= 1" json:"priority"`
    Enabled      bool      `gorm:"not null;default:true" json:"enabled"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`

    // 关联关系
    UnifiedModel UnifiedModel `gorm:"foreignKey:UnifiedModelID" json:"unified_model,omitempty"`
    Provider     Provider     `gorm:"foreignKey:ProviderID" json:"provider,omitempty"`
}

// 数据库约束
// UNIQUE(unified_model_id, provider_id, target_model) - 防止重复映射
// UNIQUE(unified_model_id, priority) - 防止优先级重复
```

#### 数据库索引

```sql
-- 主要查询索引
CREATE INDEX idx_model_mappings_unified_model_id ON model_mappings(unified_model_id);
CREATE INDEX idx_model_mappings_provider_id ON model_mappings(provider_id);

-- 复合索引用于查询优化
CREATE INDEX idx_model_mappings_unified_enabled ON model_mappings(unified_model_id, enabled);

-- 唯一约束
CREATE UNIQUE INDEX idx_model_mappings_unique_mapping ON model_mappings(unified_model_id, provider_id, target_model);
CREATE UNIQUE INDEX idx_model_mappings_unique_priority ON model_mappings(unified_model_id, priority);
```

### 2. API 端点设计

#### 添加映射
```http
POST /api/models/:id/mappings
Content-Type: application/json

{
  "provider_id": 1,
  "target_model": "gpt-4o",
  "weight": 70,
  "priority": 1,
  "enabled": true
}

Response: 201 Created
{
  "id": 1,
  "unified_model_id": 1,
  "provider_id": 1,
  "target_model": "gpt-4o",
  "weight": 70,
  "priority": 1,
  "enabled": true,
  "created_at": "2025-10-02T12:00:00Z",
  "updated_at": "2025-10-02T12:00:00Z"
}
```

#### 查询模型的所有映射
```http
GET /api/models/:id/mappings?include_provider=true

Response: 200 OK
{
  "mappings": [
    {
      "id": 1,
      "unified_model_id": 1,
      "provider_id": 1,
      "target_model": "gpt-4o",
      "weight": 70,
      "priority": 1,
      "enabled": true,
      "provider": {
        "id": 1,
        "name": "OneAPI",
        "base_url": "https://api.oneapi.com",
        "enabled": true
      },
      "created_at": "2025-10-02T12:00:00Z",
      "updated_at": "2025-10-02T12:00:00Z"
    }
  ],
  "total": 1
}
```

#### 更新映射
```http
PUT /api/mappings/:id
Content-Type: application/json

{
  "weight": 80,
  "priority": 2,
  "enabled": false
}

Response: 200 OK
{
  "id": 1,
  "unified_model_id": 1,
  "provider_id": 1,
  "target_model": "gpt-4o",
  "weight": 80,
  "priority": 2,
  "enabled": false,
  "updated_at": "2025-10-02T13:00:00Z"
}
```

#### 删除映射
```http
DELETE /api/mappings/:id

Response: 204 No Content
```

### 3. 架构设计

```
API Layer:     /api/models/:id/mappings, /api/mappings/:id
                        ↓
Handler Layer: handlers/mapping_handler.go
                        ↓
Service Layer: mapping/service.go
                        ↓
Repository:    mapping/repository.go
                        ↓
Database:      model_mappings 表
```

### 4. 错误处理

| 状态码 | 场景 | 响应格式 |
|-------|---------|----------|
| 400 | 参数验证失败 | `{"error": "权重必须在1-100之间"}` |
| 404 | 统一模型不存在 | `{"error": "统一模型不存在"}` |
| 404 | 映射不存在 | `{"error": "映射不存在"}` |
| 409 | 映射重复 | `{"error": "该模型已映射到此供应商的此目标模型"}` |
| 409 | 优先级冲突 | `{"error": "优先级已被使用"}` |
| 500 | 服务器内部错误 | `{"error": "内部服务器错误"}` |

---

## Tasks / Subtasks

### Task 1: 扩展数据模型
- [ ] 1.1 在 `internal/models/mapping.go` 中添加 `ModelMapping` 结构体
- [ ] 1.2 添加数据库约束和索引定义
- [ ] 1.3 更新 `AutoMigrate` 包含新模型
- [ ] 1.4 编写 `TableName()` 方法

### Task 2: 扩展Repository层
- [ ] 2.1 在 `internal/mapping/repository.go` 中添加映射相关方法
- [ ] 2.2 实现 `CreateMapping(mapping *models.ModelMapping) error`
- [ ] 2.3 实现 `FindMappingsByModelID(modelID uint) ([]*models.ModelMapping, error)`
- [ ] 2.4 实现 `FindMappingByID(id uint) (*models.ModelMapping, error)`
- [ ] 2.5 实现 `UpdateMapping(mapping *models.ModelMapping) error`
- [ ] 2.6 实现 `DeleteMapping(id uint) error`
- [ ] 2.7 实现 `CheckMappingExists(modelID, providerID uint, targetModel string) (bool, error)`
- [ ] 2.8 实现 `CheckPriorityExists(modelID uint, priority int, excludeID uint) (bool, error)`

### Task 3: 扩展Service层
- [ ] 3.1 在 `internal/mapping/service.go` 中添加映射相关方法
- [ ] 3.2 实现创建映射逻辑（包含验证）
- [ ] 3.3 实现查询映射逻辑（支持关联查询）
- [ ] 3.4 实现更新映射逻辑（包含业务验证）
- [ ] 3.5 实现删除映射逻辑
- [ ] 3.6 实现映射参数验证方法
- [ ] 3.7 添加映射相关 DTO 结构体

### Task 4: 创建 API 处理层
- [ ] 4.1 创建 `internal/api/handlers/mapping_handler.go`
- [ ] 4.2 实现 `CreateMapping` 处理器
- [ ] 4.3 实现 `ListMappings` 处理器
- [ ] 4.4 实现 `UpdateMapping` 处理器
- [ ] 4.5 实现 `DeleteMapping` 处理器
- [ ] 4.6 实现错误处理和响应格式化
- [ ] 4.7 添加参数绑定和验证

### Task 5: 集成路由
- [ ] 5.1 在 `internal/api/router.go` 中添加映射路由
- [ ] 5.2 注册映射 CRUD 端点
- [ ] 5.3 配置路由中间件

### Task 6: 编写测试
- [ ] 6.1 扩展 `internal/mapping/repository_test.go` 添加映射测试
- [ ] 6.2 扩展 `internal/mapping/service_test.go` 添加映射测试
- [ ] 6.3 创建 `internal/api/handlers/mapping_handler_test.go`
- [ ] 6.4 实现端到端集成测试
- [ ] 6.5 验证测试覆盖率 > 80%

---

## Testing Strategy

### Unit Tests

#### Repository 层测试
- 创建映射成功/失败场景
- 查询模型的所有映射
- 更新映射成功/失败场景
- 删除映射成功/失败场景
- 映射重复性检查
- 优先级冲突检查

#### Service 层测试
- 业务逻辑验证
- 参数验证（权重、优先级）
- 重复映射检测
- 外键约束验证
- 级联删除逻辑

#### Handler 层测试
- HTTP 请求/响应测试
- 参数解析测试
- 错误响应格式测试
- 关联查询测试

### Integration Tests
- 端到端 API 测试
- 数据库约束测试
- 外键关联测试

---

## Definition of Done

- [ ] 所有 Acceptance Criteria 通过
- [ ] 所有 Tasks/Subtasks 完成
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] API 响应时间 < 50ms
- [ ] 代码通过 `gofmt` 格式化
- [ ] 代码通过 `go vet` 检查
- [ ] 文档更新完成

---

## References

- [PRD - Epic 4 Story 4.2](../prd.md#story-42-模型映射配置)
- [ModelMapping 数据模型](../../internal/models/mapping.go)
- [Story 4.1 - 统一模型管理](./4.1.story.md)

---

## Dev Agent Record

### Implementation Notes

**实施日期**: 待开始

#### 技术决策
1. **数据约束**: 使用数据库级约束确保数据完整性
2. **关联查询**: 支持可选的关联查询以减少API调用
3. **优先级管理**: 同一模型下优先级必须唯一
4. **权重验证**: 权重范围1-100，但总和可以不等于100

#### 遵循的原则
- **KISS**: 简单直接的映射CRUD操作
- **YAGNI**: 只实现当前所需的功能
- **DRY**: 复用已有的Repository和Service模式
- **SOLID**: 清晰的职责分离

---

**Story 状态**: 待开始 ⏳
**前置条件**: Story 4.1 (统一模型管理) 已完成
**下一步**: Story 4.3 - 路由解析逻辑