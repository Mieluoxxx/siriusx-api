# Story 5.1: 加权随机负载均衡器

> **Epic 5: 负载均衡系统**
> **Story**: 5.1
> **估算**: 1 天
> **负责人**: AI Assistant
> **状态**: 开发中

## 📋 需求概述

实现基于权重的随机负载均衡算法，根据供应商权重智能分配请求，确保负载分布的公平性和高性能。

## 🎯 核心功能

### 1. 加权随机算法
- **权重计算**: 计算所有供应商的总权重
- **随机选择**: 生成随机数 (0 ~ 总权重-1)
- **累积选择**: 根据累积权重选择对应供应商
- **动态调整**: 支持运行时权重动态调整

### 2. SelectProvider 函数
- **接口设计**: `SelectProvider(mappings []ModelMapping) *ModelMapping`
- **性能要求**: 选择算法延迟 < 1ms
- **准确性要求**: 权重分配误差 < 5% (运行 1000 次)
- **边界处理**: 处理空列表、零权重等特殊情况

### 3. 负载均衡器接口
- **标准化接口**: 定义统一的负载均衡器接口
- **策略模式**: 支持多种负载均衡策略切换
- **统计信息**: 提供选择统计和分布分析

## 🏗️ 技术设计

### 架构概览
```
┌─────────────────────────────────────────┐
│           LoadBalancer Interface        │
├─────────────────────────────────────────┤
│  + SelectProvider(mappings) Provider    │
│  + GetStats() BalancerStats             │
│  + Reset()                              │
└─────────────────────────────────────────┘
                     ▲
                     │
┌─────────────────────────────────────────┐
│        WeightedRandomBalancer          │
├─────────────────────────────────────────┤
│  - random *rand.Rand                   │
│  - mutex sync.RWMutex                  │
│  - stats BalancerStats                 │
├─────────────────────────────────────────┤
│  + SelectProvider(mappings) Provider   │
│  + calculateTotalWeight(mappings) int  │
│  + selectByWeight(mappings, rand) Prov │
│  + updateStats(provider)               │
└─────────────────────────────────────────┘
```

### 核心算法实现
```go
// 加权随机选择算法
func (b *WeightedRandomBalancer) SelectProvider(mappings []*ResolvedMapping) *ResolvedMapping {
    if len(mappings) == 0 {
        return nil
    }

    // 计算总权重
    totalWeight := 0
    for _, mapping := range mappings {
        totalWeight += mapping.Weight
    }

    if totalWeight == 0 {
        // 所有权重为0，随机选择
        return mappings[b.random.Intn(len(mappings))]
    }

    // 生成随机数
    randomValue := b.random.Intn(totalWeight)

    // 累积权重选择
    currentWeight := 0
    for _, mapping := range mappings {
        currentWeight += mapping.Weight
        if randomValue < currentWeight {
            return mapping
        }
    }

    // 兜底返回最后一个
    return mappings[len(mappings)-1]
}
```

### 数据结构设计
```go
// LoadBalancer 负载均衡器接口
type LoadBalancer interface {
    SelectProvider(mappings []*ResolvedMapping) *ResolvedMapping
    GetStats() *BalancerStats
    Reset()
}

// BalancerStats 负载均衡统计
type BalancerStats struct {
    TotalSelections int64                    // 总选择次数
    ProviderCounts  map[uint]int64          // 各供应商选择次数
    LastSelection   time.Time               // 最后选择时间
    SelectionTime   time.Duration           // 平均选择耗时
}

// WeightedRandomBalancer 加权随机负载均衡器
type WeightedRandomBalancer struct {
    random *rand.Rand
    mutex  sync.RWMutex
    stats  *BalancerStats
}
```

## 🔧 实现计划

### Phase 1: 核心接口设计 (30min)
- [ ] 定义 LoadBalancer 接口
- [ ] 设计 BalancerStats 统计结构
- [ ] 创建 WeightedRandomBalancer 结构体

### Phase 2: 加权随机算法 (2h)
- [ ] 实现权重计算逻辑
- [ ] 实现随机数生成 (线程安全)
- [ ] 实现累积权重选择算法
- [ ] 添加边界条件处理

### Phase 3: 性能优化 (1h)
- [ ] 优化算法时间复杂度 O(n)
- [ ] 添加并发安全保护
- [ ] 实现统计信息收集
- [ ] 性能基准测试

### Phase 4: 测试验证 (2h)
- [ ] 单元测试 (覆盖率 > 90%)
- [ ] 权重分布验证测试
- [ ] 性能压力测试
- [ ] 边界条件测试

## 📊 验收标准

### 功能验收
- [x] ✅ 实现 `SelectProvider` 函数
- [ ] ✅ 支持动态权重调整
- [ ] ✅ 处理边界情况 (空列表、零权重)
- [ ] ✅ 线程安全实现

### 性能验收
- [ ] 🚀 权重分配误差 < 5% (运行 1000 次)
- [ ] ⚡ 选择算法延迟 < 1ms
- [ ] 📈 单元测试覆盖率 > 90%
- [ ] 🔄 支持动态权重调整

### 质量验收
- [ ] 🧪 完整的单元测试套件
- [ ] 📊 权重分布统计验证
- [ ] ⚡ 性能基准测试
- [ ] 🛡️ 并发安全测试

## 🧪 测试策略

### 1. 单元测试
```go
func TestWeightedRandomBalancer_SelectProvider(t *testing.T) {
    // 测试正常权重分配
    // 测试零权重处理
    // 测试空列表处理
    // 测试单一供应商
}

func TestWeightedRandomBalancer_WeightDistribution(t *testing.T) {
    // 运行1000次验证分布误差 < 5%
}

func BenchmarkWeightedRandomBalancer_SelectProvider(b *testing.B) {
    // 验证选择延迟 < 1ms
}
```

### 2. 分布验证测试
- **测试场景**: 3个供应商权重比例 7:2:1
- **运行次数**: 1000次选择
- **验收标准**: 实际分布与期望分布误差 < 5%
- **统计方法**: 卡方检验

### 3. 性能压力测试
- **并发测试**: 100个goroutine并发选择
- **性能要求**: 平均延迟 < 1ms
- **内存要求**: 无内存泄漏
- **稳定性**: 长时间运行稳定

## 🔗 依赖关系

### 输入依赖
- `internal/mapping/types.go` - ResolvedMapping 类型定义
- `internal/mapping/router.go` - 路由解析结果

### 输出依赖
- 为后续故障检测 (Story 5.2) 提供负载均衡基础
- 为智能故障转移 (Story 5.3) 提供选择策略

### 技术依赖
- Go 1.21+
- `math/rand` - 随机数生成
- `sync` - 并发安全
- `time` - 时间统计

## 📈 监控指标

### 业务指标
- **选择准确性**: 权重分布误差百分比
- **选择性能**: 平均选择延迟
- **供应商分布**: 各供应商选择频率

### 技术指标
- **并发性能**: 高并发场景下的选择延迟
- **内存使用**: 负载均衡器内存占用
- **CPU使用**: 选择算法CPU开销

## 🚀 部署考虑

### 配置参数
- **随机种子**: 支持自定义随机种子
- **统计窗口**: 统计信息收集时间窗口
- **性能模式**: 高性能模式 vs 高精度模式

### 运维支持
- **统计接口**: 提供负载均衡统计查询
- **重置功能**: 支持统计信息重置
- **健康检查**: 负载均衡器状态检查

---

**实现优先级**: P0 (核心功能)
**风险评估**: 低风险，算法成熟，实现清晰
**后续优化**: 支持更多负载均衡策略 (轮询、最少连接等)