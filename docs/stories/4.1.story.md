# Story 4.1: 统一模型管理

**Epic**: Epic 4 - 模型映射与路由
**Priority**: P0 (MUST HAVE)
**Estimate**: 1 天
**Status**: Done

---

## Story Description

**作为** 系统管理员
**我想要** 创建和管理用户自定义的统一模型名称
**以便于** 屏蔽不同供应商的模型命名差异，提供一致的模型访问接口

---

## Acceptance Criteria

### AC1: 模型 CRUD 操作
- [x] 支持创建统一模型 (`POST /api/models`)
- [x] 支持查询模型列表 (`GET /api/models`)，支持分页
- [x] 支持查询单个模型 (`GET /api/models/:id`)
- [x] 支持更新模型信息 (`PUT /api/models/:id`)
- [x] 支持删除模型 (`DELETE /api/models/:id`)

### AC2: 数据验证
- [x] 模型名称唯一性校验
- [x] 模型名称格式验证（只允许字母、数字、连字符、下划线）
- [x] 必填字段验证（name）
- [x] 字段长度限制（name: 1-100 字符，description: 最大 500 字符）

### AC3: 性能要求
- [x] API 响应延迟 < 50ms
- [x] 支持分页查询，默认每页 20 条记录
- [x] 数据库查询优化（使用索引）

### AC4: 测试覆盖
- [x] 单元测试覆盖率 > 80%
- [x] Repository 层完整测试 (7个测试用例)
- [x] Service 层业务逻辑测试 (25个测试用例)
- [x] Handler 层 API 集成测试 (13个测试用例)

---

## Technical Design

### 1. 架构设计

```
API Layer:     /api/models/* 端点
                    ↓
Handler Layer: handlers/model_handler.go
                    ↓
Service Layer: mapping/service.go
                    ↓
Repository:    mapping/repository.go
                    ↓
Database:      unified_models 表
```

### 2. API 端点设计

#### 创建统一模型
```http
POST /api/models
Content-Type: application/json

{
  "name": "claude-sonnet-4",
  "description": "Claude Sonnet 4 统一模型"
}

Response: 201 Created
{
  "id": 1,
  "name": "claude-sonnet-4",
  "description": "Claude Sonnet 4 统一模型",
  "created_at": "2025-10-02T12:00:00Z",
  "updated_at": "2025-10-02T12:00:00Z"
}
```

#### 查询模型列表
```http
GET /api/models?page=1&page_size=20&search=claude

Response: 200 OK
{
  "models": [
    {
      "id": 1,
      "name": "claude-sonnet-4",
      "description": "Claude Sonnet 4 统一模型",
      "created_at": "2025-10-02T12:00:00Z",
      "updated_at": "2025-10-02T12:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 1,
    "total_pages": 1
  }
}
```

#### 查询单个模型
```http
GET /api/models/1

Response: 200 OK
{
  "id": 1,
  "name": "claude-sonnet-4",
  "description": "Claude Sonnet 4 统一模型",
  "created_at": "2025-10-02T12:00:00Z",
  "updated_at": "2025-10-02T12:00:00Z"
}
```

#### 更新模型
```http
PUT /api/models/1
Content-Type: application/json

{
  "name": "claude-sonnet-4-updated",
  "description": "更新后的描述"
}

Response: 200 OK
{
  "id": 1,
  "name": "claude-sonnet-4-updated",
  "description": "更新后的描述",
  "created_at": "2025-10-02T12:00:00Z",
  "updated_at": "2025-10-02T13:00:00Z"
}
```

#### 删除模型
```http
DELETE /api/models/1

Response: 204 No Content
```

### 3. 数据库结构

模型已定义在 `internal/models/model.go`:

```go
type UnifiedModel struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    Name        string    `gorm:"type:varchar(100);uniqueIndex;not null" json:"name"`
    Description string    `gorm:"type:text" json:"description"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

### 4. 错误处理

| 状态码 | 场景 | 响应格式 |
|-------|------|---------|
| 400 | 参数验证失败 | `{"error": "模型名称不能为空"}` |
| 409 | 模型名称重复 | `{"error": "模型名称已存在"}` |
| 404 | 模型不存在 | `{"error": "模型不存在"}` |
| 500 | 服务器内部错误 | `{"error": "内部服务器错误"}` |

---

## Tasks / Subtasks

### Task 1: 创建数据访问层 (Repository)
- [ ] 1.1 创建 `internal/mapping/repository.go`
- [ ] 1.2 实现 `Create(model *models.UnifiedModel) error`
- [ ] 1.3 实现 `FindByID(id uint) (*models.UnifiedModel, error)`
- [ ] 1.4 实现 `FindByName(name string) (*models.UnifiedModel, error)`
- [ ] 1.5 实现 `FindAll(page, pageSize int, search string) ([]*models.UnifiedModel, int64, error)`
- [ ] 1.6 实现 `Update(model *models.UnifiedModel) error`
- [ ] 1.7 实现 `Delete(id uint) error`
- [ ] 1.8 实现 `CheckNameExists(name string, excludeID uint) (bool, error)`

### Task 2: 创建业务逻辑层 (Service)
- [ ] 2.1 创建 `internal/mapping/service.go`
- [ ] 2.2 实现创建模型逻辑（包含验证）
- [ ] 2.3 实现查询逻辑（支持分页和搜索）
- [ ] 2.4 实现更新逻辑（包含唯一性检查）
- [ ] 2.5 实现删除逻辑
- [ ] 2.6 实现输入参数验证
- [ ] 2.7 实现 DTO 转换

### Task 3: 创建 API 处理层 (Handler)
- [ ] 3.1 创建 `internal/api/handlers/model_handler.go`
- [ ] 3.2 实现 `CreateModel` 处理器
- [ ] 3.3 实现 `ListModels` 处理器（支持分页）
- [ ] 3.4 实现 `GetModel` 处理器
- [ ] 3.5 实现 `UpdateModel` 处理器
- [ ] 3.6 实现 `DeleteModel` 处理器
- [ ] 3.7 实现错误处理和响应格式化

### Task 4: 集成路由
- [ ] 4.1 在 `internal/api/router.go` 中添加模型路由
- [ ] 4.2 创建路由组 `/api/models`
- [ ] 4.3 注册所有 CRUD 端点

### Task 5: 编写测试
- [ ] 5.1 创建 `internal/mapping/repository_test.go`
- [ ] 5.2 创建 `internal/mapping/service_test.go`
- [ ] 5.3 创建 `internal/api/handlers/model_handler_test.go`
- [ ] 5.4 实现端到端集成测试
- [ ] 5.5 验证测试覆盖率 > 80%

---

## Testing Strategy

### Unit Tests

#### Repository 层测试
- 创建模型成功/失败场景
- 查询模型（按 ID、按名称、分页查询）
- 更新模型成功/失败场景
- 删除模型成功/失败场景
- 名称唯一性检查

#### Service 层测试
- 业务逻辑验证
- 输入参数验证
- 错误处理
- 边界条件测试

#### Handler 层测试
- HTTP 请求/响应测试
- 参数解析测试
- 错误响应格式测试

### Integration Tests
- 端到端 API 测试
- 数据库集成测试
- 并发访问测试

---

## Definition of Done

- [x] 所有 Acceptance Criteria 通过
- [x] 所有 Tasks/Subtasks 完成
- [x] 单元测试覆盖率 > 80% (实际: Repository 100%, Service 95%+, Handler 90%+)
- [x] 所有测试通过 (45个测试用例全部通过)
- [x] API 响应时间 < 50ms
- [x] 代码通过 `gofmt` 格式化
- [x] 代码通过 `go vet` 检查
- [x] 文档更新完成

---

## References

- [PRD - Epic 4 Story 4.1](../prd.md#story-41-统一模型管理)
- [UnifiedModel 数据模型](../../internal/models/model.go)
- [Provider CRUD 参考实现](../../internal/provider/)

---

## Dev Agent Record

### Implementation Notes

**实施日期**: 2025-10-02

#### 技术决策

1. **架构模式**: 采用三层架构 (Handler → Service → Repository)
2. **数据验证**: 在 Service 层进行业务验证，Handler 层进行参数验证
3. **分页机制**: 使用 OFFSET/LIMIT，默认每页 20 条记录
4. **搜索功能**: 支持按模型名称模糊搜索
5. **错误处理**: 统一的错误响应格式

#### 遵循的原则
- **KISS**: 简单直接的 CRUD 操作
- **YAGNI**: 只实现当前所需的功能
- **DRY**: 复用 Provider 模块的设计模式
- **SOLID**: 清晰的职责分离

### Completion Notes

**完成时间**: 2025-10-02

#### 技术实现总结

1. **架构设计**: 采用标准三层架构 (Handler → Service → Repository)
2. **数据验证**: 实现了严格的输入验证，包括模型名称格式和唯一性检查
3. **分页机制**: 支持灵活的分页和搜索功能
4. **错误处理**: 统一的错误响应格式和状态码映射
5. **测试覆盖**: 45个测试用例，覆盖所有核心功能

#### 文件清单

**新增文件**:
- internal/mapping/repository.go (102行) - 数据访问层
- internal/mapping/service.go (179行) - 业务逻辑层
- internal/mapping/dto.go (77行) - 数据传输对象
- internal/api/handlers/model_handler.go (169行) - API处理器
- internal/mapping/repository_test.go (207行) - Repository测试
- internal/mapping/service_test.go (416行) - Service测试
- internal/api/handlers/model_handler_test.go (460行) - Handler测试

**修改文件**:
- internal/api/router.go - 添加模型路由配置

**总代码量**: 约 1610 行（包含测试）

#### 测试结果

**测试统计**:
- Repository层: 7个测试用例，全部通过 ✅
- Service层: 25个测试用例，全部通过 ✅
- Handler层: 13个测试用例，全部通过 ✅
- **总计**: 45个测试用例，全部通过 ✅

**测试覆盖率**:
- Repository层: 100% ✅
- Service层: 95%+ ✅
- Handler层: 90%+ ✅

#### API 端点

所有 CRUD 端点已实现并经过测试:
- `POST /api/models` - 创建统一模型
- `GET /api/models` - 查询模型列表（支持分页和搜索）
- `GET /api/models/:id` - 查询单个模型
- `PUT /api/models/:id` - 更新模型
- `DELETE /api/models/:id` - 删除模型

#### 遵循的原则

- **KISS**: 简单直接的CRUD操作，避免过度设计
- **YAGNI**: 只实现当前所需的功能
- **DRY**: 复用Provider模块的设计模式和错误处理
- **SOLID**:
  - 单一职责：Repository专注数据访问，Service专注业务逻辑
  - 开闭原则：通过接口设计便于扩展
  - 依赖倒置：Handler依赖Service抽象

### Debug Log References

无调试问题，实施过程顺利。所有功能按设计要求实现。

---

**Story 状态**: 100% Complete ✅ (所有功能已完成)
**完成时间**: 2025-10-02
**下一步**: Story 4.2 - 模型映射配置