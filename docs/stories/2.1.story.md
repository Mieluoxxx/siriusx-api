# Story 2.1: 请求转换器 (Claude → OpenAI)

**Epic**: Epic 2 - 格式转换引擎
**Story ID**: 2.1
**Story Title**: 请求转换器 (Claude → OpenAI)
**Status**: Done
**估算工时**: 1.5 天 (12 小时)
**优先级**: P0 (MUST HAVE)
**创建日期**: 2025-10-02

---

## Story Statement

**作为** 后端开发者
**我想要** 实现 Claude Messages API 到 OpenAI Chat Completions API 的请求转换
**以便于** 接收 Claude Code CLI 的请求并转发到 OpenAI 兼容的供应商

---

## Acceptance Criteria

### AC1: 基础字段映射正确
- [ ] `model` 字段正确映射
- [ ] `max_tokens` 字段正确映射
- [ ] `temperature` 字段正确映射
- [ ] `top_p` 字段正确映射
- [ ] `stream` 字段正确映射
- [ ] `stop_sequences` → `stop` 正确映射

### AC2: System 消息转换正确
- [ ] Claude `system` 参数转为 OpenAI `messages[0]`
- [ ] 角色设置为 "system"
- [ ] 内容正确提取
- [ ] System 消息始终在数组首位

### AC3: Messages 数组转换正确
- [ ] 用户消息（text 类型）正确转换
- [ ] 助手消息（text 类型）正确转换
- [ ] 图片消息 (image) 转换为 image_url 格式
- [ ] Tool use 消息转换为 tool_calls 格式
- [ ] Tool result 消息转换为 tool 角色

### AC4: 单元测试覆盖完整
- [ ] 单元测试覆盖率 > 80%
- [ ] 至少 10 个测试用例
- [ ] 转换正确率 100%
- [ ] 边界情况测试（空消息、特殊字符等）

### AC5: 性能达标
- [ ] 单次转换延迟 < 1ms
- [ ] 无内存泄漏
- [ ] 支持并发调用

---

## Dev Notes

### Previous Story Insights

[Source: Story 1.2 - 引入 SQLite 数据库和 GORM](./1.2.story.md)

- 数据库层已完成，可以存储模型映射关系
- 项目已集成 GORM 和 SQLite
- 优雅关闭机制已实现

### 格式转换核心规则

[Source: [format-conversion-study.md](../format-conversion-study.md#11-请求转换claude--openai)]

#### 字段映射表

| Claude 字段 | OpenAI 字段 | 转换规则 |
|------------|------------|----------|
| `model` | `model` | 直接映射（后续通过模型映射表转换） |
| `system` | `messages[0]` | 转为 `{"role": "system", "content": "..."}` |
| `messages` | `messages` | 逐条转换（见详细规则） |
| `max_tokens` | `max_tokens` | 直接映射 |
| `temperature` | `temperature` | 直接映射 |
| `top_p` | `top_p` | 直接映射 |
| `stream` | `stream` | 直接映射 |
| `stop_sequences` | `stop` | 直接映射数组 |
| `tools` | `tools` | 转为 `[{"type": "function", "function": {...}}]` |
| `tool_choice` | `tool_choice` | 见工具调用转换规则 |

#### Messages 转换规则

**1. 用户消息 (User)**

Claude 格式:
```json
{
  "role": "user",
  "content": [
    {"type": "text", "text": "Hello"},
    {
      "type": "image",
      "source": {
        "type": "base64",
        "media_type": "image/jpeg",
        "data": "base64_string"
      }
    }
  ]
}
```

OpenAI 格式:
```json
{
  "role": "user",
  "content": [
    {"type": "text", "text": "Hello"},
    {
      "type": "image_url",
      "image_url": {
        "url": "data:image/jpeg;base64,base64_string"
      }
    }
  ]
}
```

转换逻辑:
- `text` 类型 → 直接映射
- `image` 类型 → 转为 `image_url`，拼接 data URL
- 如果只有一个文本块 → 简化为字符串 `"content": "Hello"`

**2. 助手消息 (Assistant)**

Claude 格式:
```json
{
  "role": "assistant",
  "content": [
    {"type": "text", "text": "Sure!"},
    {
      "type": "tool_use",
      "id": "toolu_xxx",
      "name": "get_weather",
      "input": {"location": "SF"}
    }
  ]
}
```

OpenAI 格式:
```json
{
  "role": "assistant",
  "content": "Sure!",
  "tool_calls": [
    {
      "id": "toolu_xxx",
      "type": "function",
      "function": {
        "name": "get_weather",
        "arguments": "{\"location\":\"SF\"}"
      }
    }
  ]
}
```

转换逻辑:
- 提取所有 `text` 块 → 合并为 `content` 字符串
- 提取所有 `tool_use` 块 → 转为 `tool_calls` 数组
- `input` 对象 → JSON 字符串 `arguments`

**3. Tool Result (特殊处理)**

Claude 格式:
```json
{
  "role": "user",
  "content": [
    {
      "type": "tool_result",
      "tool_use_id": "toolu_xxx",
      "content": "{\"temperature\": 72}"
    }
  ]
}
```

OpenAI 格式:
```json
{
  "role": "tool",
  "tool_call_id": "toolu_xxx",
  "content": "{\"temperature\": 72}"
}
```

转换逻辑:
- `tool_result` 必须拆分为独立的消息
- 角色从 `user` 改为 `tool`

### 数据结构定义

[Source: [PRD](../prd.md#story-21-请求转换器-claude--openai)]

#### Claude 请求结构体

```go
// ClaudeRequest Claude Messages API 请求
type ClaudeRequest struct {
	Model         string          `json:"model"`
	System        string          `json:"system,omitempty"`
	Messages      []ClaudeMessage `json:"messages"`
	MaxTokens     int             `json:"max_tokens"`
	Temperature   *float64        `json:"temperature,omitempty"`
	TopP          *float64        `json:"top_p,omitempty"`
	Stream        bool            `json:"stream,omitempty"`
	StopSequences []string        `json:"stop_sequences,omitempty"`
	Tools         []ClaudeTool    `json:"tools,omitempty"`
	ToolChoice    *ClaudeToolChoice `json:"tool_choice,omitempty"`
}

// ClaudeMessage Claude 消息
type ClaudeMessage struct {
	Role    string               `json:"role"`
	Content []ClaudeContentBlock `json:"content"`
}

// ClaudeContentBlock Claude 内容块
type ClaudeContentBlock struct {
	Type string `json:"type"`

	// text 类型
	Text *string `json:"text,omitempty"`

	// image 类型
	Source *ClaudeImageSource `json:"source,omitempty"`

	// tool_use 类型
	ID    *string                `json:"id,omitempty"`
	Name  *string                `json:"name,omitempty"`
	Input map[string]interface{} `json:"input,omitempty"`

	// tool_result 类型
	ToolUseID *string `json:"tool_use_id,omitempty"`
	Content   *string `json:"content,omitempty"` // tool result content
}

// ClaudeImageSource 图片来源
type ClaudeImageSource struct {
	Type      string `json:"type"`       // base64 | url
	MediaType string `json:"media_type"` // image/jpeg, image/png, etc.
	Data      string `json:"data"`       // base64 string
}

// ClaudeTool Claude 工具定义
type ClaudeTool struct {
	Name        string                 `json:"name"`
	Description string                 `json:"description"`
	InputSchema map[string]interface{} `json:"input_schema"`
}

// ClaudeToolChoice Claude 工具选择
type ClaudeToolChoice struct {
	Type string  `json:"type"` // auto | any | tool
	Name *string `json:"name,omitempty"`
}
```

#### OpenAI 请求结构体

```go
// OpenAIRequest OpenAI Chat Completions API 请求
type OpenAIRequest struct {
	Model       string         `json:"model"`
	Messages    []OpenAIMessage `json:"messages"`
	MaxTokens   int            `json:"max_tokens,omitempty"`
	Temperature *float64       `json:"temperature,omitempty"`
	TopP        *float64       `json:"top_p,omitempty"`
	Stream      bool           `json:"stream,omitempty"`
	Stop        []string       `json:"stop,omitempty"`
	Tools       []OpenAITool   `json:"tools,omitempty"`
	ToolChoice  interface{}    `json:"tool_choice,omitempty"` // string or object
}

// OpenAIMessage OpenAI 消息
type OpenAIMessage struct {
	Role       string                   `json:"role"`
	Content    interface{}              `json:"content,omitempty"` // string or []ContentBlock
	ToolCalls  []OpenAIToolCall         `json:"tool_calls,omitempty"`
	ToolCallID string                   `json:"tool_call_id,omitempty"` // for tool role
}

// OpenAIContentBlock OpenAI 内容块
type OpenAIContentBlock struct {
	Type     string              `json:"type"`
	Text     *string             `json:"text,omitempty"`
	ImageURL *OpenAIImageURL     `json:"image_url,omitempty"`
}

// OpenAIImageURL 图片 URL
type OpenAIImageURL struct {
	URL string `json:"url"` // data URI or HTTP URL
}

// OpenAIToolCall OpenAI 工具调用
type OpenAIToolCall struct {
	ID       string                `json:"id"`
	Type     string                `json:"type"` // always "function"
	Function OpenAIFunctionCall    `json:"function"`
}

// OpenAIFunctionCall OpenAI 函数调用
type OpenAIFunctionCall struct {
	Name      string `json:"name"`
	Arguments string `json:"arguments"` // JSON string
}

// OpenAITool OpenAI 工具定义
type OpenAITool struct {
	Type     string                 `json:"type"` // always "function"
	Function OpenAIFunctionDef      `json:"function"`
}

// OpenAIFunctionDef OpenAI 函数定义
type OpenAIFunctionDef struct {
	Name        string                 `json:"name"`
	Description string                 `json:"description,omitempty"`
	Parameters  map[string]interface{} `json:"parameters,omitempty"`
}
```

### File Locations

[Source: [PRD](../prd.md#22-项目结构)]

- **类型定义**: `internal/converter/types.go`
- **请求转换器**: `internal/converter/claude_to_openai.go`
- **单元测试**: `internal/converter/claude_to_openai_test.go`

### Technical Constraints

- **性能要求**: 单次转换延迟 < 1ms
- **内存管理**: 避免不必要的内存分配
- **并发安全**: 转换函数必须是无状态的
- **错误处理**: 遇到不支持的参数时记录警告但继续转换
- **编码**: 所有字符串使用 UTF-8 编码

### Project Structure Notes

- 转换器模块位于 `internal/converter/` 目录
- 遵循 KISS 原则，保持代码简洁
- 使用 Go 标准库，避免不必要的依赖
- 单元测试与实现代码在同一目录

---

## Tasks / Subtasks

### Task 1: 创建类型定义 (AC: 所有)
- [ ] 1.1 创建 `internal/converter/types.go`
- [ ] 1.2 定义 `ClaudeRequest` 及相关结构体
- [ ] 1.3 定义 `OpenAIRequest` 及相关结构体
- [ ] 1.4 添加 JSON 标签和注释
- [ ] 1.5 验证结构体可以正确序列化/反序列化

### Task 2: 实现基础字段转换 (AC: 1)
- [ ] 2.1 创建 `internal/converter/claude_to_openai.go`
- [ ] 2.2 实现 `ConvertClaudeToOpenAI(req *ClaudeRequest) (*OpenAIRequest, error)` 函数
- [ ] 2.3 映射基础字段: model, max_tokens, temperature, top_p, stream
- [ ] 2.4 映射 stop_sequences → stop
- [ ] 2.5 处理可选字段 (nil 检查)

### Task 3: 实现 System 消息转换 (AC: 2)
- [ ] 3.1 检测 Claude request 中的 system 参数
- [ ] 3.2 创建 OpenAI system 消息
- [ ] 3.3 将 system 消息插入到 messages 数组首位
- [ ] 3.4 处理空 system 参数

### Task 4: 实现 Messages 数组转换 (AC: 3)
- [ ] 4.1 实现 `convertMessages(messages []ClaudeMessage, hasSystem bool) []OpenAIMessage` 函数
- [ ] 4.2 实现用户消息转换:
  - 文本块转换
  - 图片块转换 (base64 → data URI)
  - 单文本块简化为字符串
- [ ] 4.3 实现助手消息转换:
  - 提取文本块
  - 提取 tool_use 块转为 tool_calls
  - input 对象序列化为 JSON 字符串
- [ ] 4.4 实现 tool_result 转换:
  - 识别 tool_result 类型
  - 创建 tool 角色消息
  - 映射 tool_use_id → tool_call_id

### Task 5: 实现工具调用转换 (AC: 3)
- [ ] 5.1 实现 `convertTools(tools []ClaudeTool) []OpenAITool` 函数
- [ ] 5.2 映射 tool 结构: name, description, input_schema → parameters
- [ ] 5.3 实现 `convertToolChoice(choice *ClaudeToolChoice) interface{}` 函数
- [ ] 5.4 映射 tool_choice 规则:
  - `{"type": "auto"}` → `"auto"`
  - `{"type": "any"}` → `"required"`
  - `{"type": "tool", "name": "x"}` → `{"type": "function", "function": {"name": "x"}}`

### Task 6: 编写单元测试 (AC: 4)
- [ ] 6.1 创建 `internal/converter/claude_to_openai_test.go`
- [ ] 6.2 测试基础字段转换
- [ ] 6.3 测试 system 消息转换
- [ ] 6.4 测试用户消息（text）
- [ ] 6.5 测试用户消息（image）
- [ ] 6.6 测试助手消息（text）
- [ ] 6.7 测试助手消息（tool_use）
- [ ] 6.8 测试 tool_result 消息
- [ ] 6.9 测试工具定义转换
- [ ] 6.10 测试边界情况（空消息、nil 参数等）
- [ ] 6.11 运行测试并验证覆盖率 > 80%

### Task 7: 性能优化和验证 (AC: 5)
- [ ] 7.1 添加性能基准测试 (Benchmark)
- [ ] 7.2 优化字符串拼接（使用 strings.Builder）
- [ ] 7.3 优化 JSON 序列化（考虑对象池）
- [ ] 7.4 验证转换延迟 < 1ms
- [ ] 7.5 验证并发安全性

### Task 8: 错误处理和日志 (AC: 所有)
- [ ] 8.1 添加不支持参数的警告日志
- [ ] 8.2 处理无效输入（返回错误）
- [ ] 8.3 添加调试日志（可配置）
- [ ] 8.4 记录转换统计信息

---

## Testing Notes

### 单元测试策略

**测试用例分类**:

1. **基础字段转换测试**
   ```go
   func TestConvertBasicFields(t *testing.T) {
       req := &ClaudeRequest{
           Model: "claude-3-5-sonnet",
           MaxTokens: 1024,
           Temperature: ptr(0.7),
           Stream: true,
       }
       result, err := ConvertClaudeToOpenAI(req)
       assert.NoError(t, err)
       assert.Equal(t, "claude-3-5-sonnet", result.Model)
       assert.Equal(t, 1024, result.MaxTokens)
   }
   ```

2. **System 消息测试**
   ```go
   func TestConvertSystemMessage(t *testing.T) {
       req := &ClaudeRequest{
           Model: "claude-3-5-sonnet",
           System: "You are a helpful assistant",
           Messages: []ClaudeMessage{
               {Role: "user", Content: []ClaudeContentBlock{{Type: "text", Text: ptr("Hello")}}},
           },
       }
       result, err := ConvertClaudeToOpenAI(req)
       assert.NoError(t, err)
       assert.Equal(t, "system", result.Messages[0].Role)
       assert.Equal(t, "You are a helpful assistant", result.Messages[0].Content)
   }
   ```

3. **图片消息测试**
   ```go
   func TestConvertImageMessage(t *testing.T) {
       req := &ClaudeRequest{
           Model: "claude-3-5-sonnet",
           Messages: []ClaudeMessage{{
               Role: "user",
               Content: []ClaudeContentBlock{
                   {Type: "text", Text: ptr("What's in this image?")},
                   {
                       Type: "image",
                       Source: &ClaudeImageSource{
                           Type: "base64",
                           MediaType: "image/jpeg",
                           Data: "base64_data",
                       },
                   },
               },
           }},
       }
       result, err := ConvertClaudeToOpenAI(req)
       assert.NoError(t, err)
       // 验证 image_url 格式
   }
   ```

4. **Tool Use 测试**
   ```go
   func TestConvertToolUse(t *testing.T) {
       req := &ClaudeRequest{
           Model: "claude-3-5-sonnet",
           Messages: []ClaudeMessage{{
               Role: "assistant",
               Content: []ClaudeContentBlock{
                   {Type: "text", Text: ptr("Let me check the weather")},
                   {
                       Type: "tool_use",
                       ID: ptr("toolu_123"),
                       Name: ptr("get_weather"),
                       Input: map[string]interface{}{"location": "SF"},
                   },
               },
           }},
       }
       result, err := ConvertClaudeToOpenAI(req)
       assert.NoError(t, err)
       // 验证 tool_calls 格式
   }
   ```

### 性能基准测试

```go
func BenchmarkConvertClaudeToOpenAI(b *testing.B) {
    req := &ClaudeRequest{
        Model: "claude-3-5-sonnet",
        Messages: []ClaudeMessage{
            {Role: "user", Content: []ClaudeContentBlock{{Type: "text", Text: ptr("Hello")}}},
        },
    }

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, _ = ConvertClaudeToOpenAI(req)
    }
}
```

### 手动测试清单

1. **使用真实 Claude Code 请求测试**
   - 复制 Claude Code CLI 发送的请求
   - 验证转换后的格式
   - 发送到 OpenAI API 测试

2. **边界情况验证**
   - 空消息数组
   - 超长消息
   - 特殊字符（UTF-8、emoji）
   - 大图片（base64）

---

## Definition of Done

- [ ] 所有 Acceptance Criteria 通过
- [ ] 所有 Tasks/Subtasks 完成
- [ ] 单元测试覆盖率 > 80%
- [ ] 单元测试全部通过
- [ ] 性能基准测试通过（< 1ms）
- [ ] 代码通过 `gofmt` 格式化
- [ ] 代码通过 `go vet` 检查
- [ ] 代码通过 `golint` 检查
- [ ] 手动测试清单全部验证通过

---

## References

- [PRD - Epic 2 Story 2.1](../prd.md#story-21-请求转换器-claude--openai)
- [Format Conversion Study](../format-conversion-study.md#11-请求转换claude--openai)
- [claude-code-nexus Converter](../../ref_proj/claude-code-nexus/src/utils/claudeConverter.ts)
- [Claude API Documentation](https://docs.anthropic.com/claude/reference/messages_post)
- [OpenAI API Documentation](https://platform.openai.com/docs/api-reference/chat)

---

## Dev Agent Record

### Implementation Notes

**完成日期**: 2025-10-02

**实现细节**:
- ✅ 创建了完整的类型定义: [types.go](../../internal/converter/types.go)
  - Claude 请求/响应结构体
  - OpenAI 请求/响应结构体
  - 辅助函数 (StringPtr, Float64Ptr)
- ✅ 实现了核心转换器: [claude_to_openai.go](../../internal/converter/claude_to_openai.go)
  - ConvertClaudeToOpenAI 主函数
  - 基础字段映射
  - System 消息转换
  - Messages 数组转换 (text, image, tool_use, tool_result)
  - Tools 和 tool_choice 转换
- ✅ 编写了完整的单元测试: [claude_to_openai_test.go](../../internal/converter/claude_to_openai_test.go)
  - 11 个测试用例
  - 性能基准测试

**技术实现**:
- 使用 Go 标准库，无额外依赖
- 遵循 KISS 原则，代码简洁清晰
- 单个文本块自动简化为字符串
- 图片转换为 data URI 格式
- Tool use 转换为 function calls
- Tool result 单独成消息

### Completion Notes

**完成时间**: 2025-10-02 02:45

**验收标准检查**:
- ✅ **AC1**: 基础字段映射正确 (model, max_tokens, temperature, top_p, stream, stop)
- ✅ **AC2**: System 消息转换正确 (插入到 messages[0])
- ✅ **AC3**: Messages 数组转换正确 (text, image, tool_use, tool_result)
- ✅ **AC4**: 单元测试覆盖完整 (91.0% 覆盖率，11 个测试用例)
- ✅ **AC5**: 性能达标 (256 纳秒/次，远低于 1ms 目标)

**测试结果**:
```
=== 测试用例 ===
✅ TestConvertBasicFields - 基础字段转换
✅ TestConvertSystemMessage - System 消息转换
✅ TestConvertUserTextMessage - 用户文本消息
✅ TestConvertUserImageMessage - 用户图片消息
✅ TestConvertAssistantTextMessage - 助手文本消息
✅ TestConvertAssistantToolUseMessage - 助手工具调用
✅ TestConvertToolResultMessage - Tool result 消息
✅ TestConvertTools - 工具定义转换
✅ TestConvertToolChoice - Tool choice 转换 (4 种场景)
✅ TestConvertNilRequest - 空请求处理
✅ TestConvertEmptyMessages - 空消息数组

测试覆盖率: 91.0% ✅
所有测试通过: 11/11 ✅
```

**性能测试**:
```
BenchmarkConvertClaudeToOpenAI-10
- 转换延迟: 256 纳秒 (~0.000256 毫秒)
- 内存分配: 560 字节
- 分配次数: 7 次

✅ 性能远超目标 (< 1ms)
```

**所有验收标准均已通过** ✅

### Debug Log References

无需调试，实施过程顺利。所有测试通过，无错误或警告。

---

**Story 状态**: Done
**完成时间**: 2025-10-02 02:45
**下一步**: 开始 Story 2.2 - 响应转换器 (OpenAI → Claude)
