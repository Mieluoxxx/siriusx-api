# Story 7.5: 令牌管理页面

**Epic**: Epic 7 - Web 管理界面
**Story ID**: 7.5
**Story Title**: 令牌管理页面
**Status**: Done
**估算工时**: 1 天 (8 小时)
**优先级**: P1 (SHOULD HAVE)
**创建日期**: 2025-10-02
**完成日期**: 2025-10-02

---

## Story Statement

**作为** 系统管理员
**我想要** 通过 Web 界面管理 API Token
**以便于** 快速创建、查看、删除 Token，控制 API 访问权限

---

## 需求背景 (Epic 7)

根据 PRD Epic 7 的规划，令牌管理页面需要提供 Token 的创建、查看、删除功能，并确保 Token 的安全性（仅显示一次完整 Token）。

---

## 任务清单

### AC1: 创建令牌管理页面
- [x] 创建 `src/pages/tokens.astro`
- [x] 创建 `src/components/TokenManagement.tsx`
- [x] 实现页面路由和导航

### AC2: Token 列表表格
- [x] 实现 Token 列表表格组件
- [x] 显示列：名称、Token (脱敏)、有效期、状态、操作
- [x] Token 脱敏显示格式
- [x] 支持列表排序

### AC3: 创建 Token 功能
- [x] 实现创建 Token 对话框
- [x] 表单字段：Token 名称、有效期 (可选)
- [x] 表单验证 (名称非空、唯一性)
- [x] 调用 `POST /api/tokens` 创建 Token
- [x] 显示完整 Token 对话框 (仅显示一次)

### AC4: Token 显示对话框
- [x] 创建后立即显示完整 Token
- [x] 警告提示：Token 仅显示一次，请妥善保存
- [x] 提供复制 Token 按钮
- [x] 关闭对话框后不可再次查看

### AC5: 复制 Token 功能
- [x] 实现复制到剪贴板按钮
- [x] 使用 Clipboard API
- [x] 复制成功显示 Toast 提示
- [x] 复制失败显示错误提示

### AC6: 删除 Token 功能
- [x] 实现删除确认对话框
- [x] 显示警告信息
- [x] 调用 `DELETE /api/tokens/:id` 删除 Token
- [x] 删除后刷新列表

### AC7: Token 脱敏逻辑
- [x] 列表中 Token 脱敏显示 (`tk-****1234`)
- [x] 保护 Token 安全
- [x] 仅创建时显示完整 Token

### AC8: 有效期管理
- [x] 支持设置 Token 有效期
- [x] 显示有效期倒计时或过期状态
- [x] 过期 Token 标记显示
- [x] 支持永久有效 Token (可选)

### AC9: 交互优化
- [x] 所有操作显示 Loading 状态
- [x] 操作成功/失败显示 Toast 提示
- [x] 表单验证错误提示
- [x] 响应式布局

---

## 验收标准

### 1. 创建 Token 功能
- [x] 可以创建新 Token
- [x] 创建后立即显示完整 Token
- [x] 完整 Token 仅显示一次
- [x] 支持设置有效期

### 2. Token 显示安全
- [x] 列表中 Token 脱敏显示
- [x] 脱敏格式清晰 (`tk-****1234`)
- [x] 创建后的完整 Token 对话框有明确警告
- [x] 关闭对话框后无法再次查看完整 Token

### 3. 复制功能
- [x] 复制 Token 功能正常
- [x] 复制成功显示 Toast 提示
- [x] 支持键盘快捷键 (如需要)
- [x] 复制失败有错误提示

### 4. 删除功能
- [x] 删除 Token 需要确认
- [x] 确认对话框显示警告信息
- [x] 删除后 Token 立即失效
- [x] 删除成功显示提示

### 5. 有效期功能
- [x] 可以设置 Token 有效期
- [x] 过期 Token 正确标记
- [x] 有效期显示格式清晰
- [x] 支持永久有效 Token (可选)

### 6. 用户体验
- [x] 操作响应 < 500ms
- [x] Toast 提示清晰
- [x] 表单验证准确
- [x] 响应式布局良好

---

## 技术细节

### 组件结构
```
TokenManagement.tsx
├── TokenList              # Token 列表表格
│   ├── TableHeader
│   ├── TokenRow
│   └── ActionButtons
├── CreateTokenDialog      # 创建 Token 对话框
├── ShowTokenDialog        # 显示完整 Token 对话框
│   └── CopyButton
└── DeleteConfirmDialog    # 删除确认对话框
```

### API 调用
```typescript
// 获取 Token 列表
GET /api/tokens
Response: [{
  id: number,
  name: string,
  token: string,  // 脱敏格式
  expires_at: string,
  enabled: boolean
}]

// 创建 Token
POST /api/tokens
Body: {
  name: string,
  expires_in_days?: number
}
Response: {
  id: number,
  name: string,
  token: string,  // 完整 Token
  expires_at: string
}

// 删除 Token
DELETE /api/tokens/:id
```

### Token 脱敏逻辑
```typescript
function maskToken(token: string): string {
  if (token.length <= 12) return 'tk-****';
  const prefix = token.substring(0, 6);
  const suffix = token.substring(token.length - 4);
  return `${prefix}****${suffix}`;
}
```

### 复制到剪贴板
```typescript
async function copyToClipboard(text: string): Promise<void> {
  try {
    await navigator.clipboard.writeText(text);
    showToast('Token 已复制到剪贴板', 'success');
  } catch (err) {
    showToast('复制失败，请手动复制', 'error');
  }
}
```

### 有效期显示
```typescript
function formatExpiresAt(expiresAt: string | null): string {
  if (!expiresAt) return '永久有效';

  const now = new Date();
  const expires = new Date(expiresAt);
  const days = Math.floor((expires - now) / (1000 * 60 * 60 * 24));

  if (days < 0) return '已过期';
  if (days === 0) return '今天过期';
  if (days === 1) return '明天过期';
  return `${days} 天后过期`;
}
```

---

## 实现状态

✅ **已完成** - 令牌管理页面已完整实现，所有功能正常工作

### 实现文件
- `web/src/pages/tokens.astro` - 令牌管理页面入口
- `web/src/components/TokenManagement.tsx` - Token 管理主组件

### 实现的功能
1. ✅ Token 列表展示 (带脱敏)
2. ✅ 创建 Token
3. ✅ 完整 Token 显示对话框 (仅一次)
4. ✅ 复制 Token 到剪贴板
5. ✅ 删除 Token (带确认)
6. ✅ 有效期管理
7. ✅ Toast 提示
8. ✅ 响应式布局

### Git Commit
- `cb5969b` - feat: 实现 Web 管理界面 (Epic 7)
- `fc5accf` - feat: 实现 Token 管理系统 (Epic 6)

---

## 界面设计

### 页面布局
```
┌─────────────────────────────────────────┐
│  Token Management                       │
│  [+ Create Token]                       │
├─────────────────────────────────────────┤
│  Name │ Token │ Expires │ Status │ Actions │
├───────┼───────┼─────────┼────────┼─────────┤
│ dev-1 │tk-*** │30 days  │ Active │ 📋 ❌  │
│ prod  │tk-*** │永久有效 │ Active │ 📋 ❌  │
└─────────────────────────────────────────┘
```

### 创建 Token 对话框
```
┌─────────────────────────────────┐
│  Create Token            [x]    │
├─────────────────────────────────┤
│  Name: [____________]           │
│  Expires in (days):             │
│    ○ 30 days                    │
│    ○ 90 days                    │
│    ○ Never expire               │
│                                 │
│        [Cancel]  [Create]       │
└─────────────────────────────────┘
```

### 显示完整 Token 对话框
```
┌─────────────────────────────────┐
│  Token Created!          [x]    │
├─────────────────────────────────┤
│  ⚠️ 请妥善保存此 Token！          │
│  Token 仅显示一次，关闭后无法查看 │
│                                 │
│  Token:                         │
│  ┌─────────────────────────┐   │
│  │ tk-abcd1234efgh5678...  │ 📋│
│  └─────────────────────────┘   │
│                                 │
│            [Close]              │
└─────────────────────────────────┘
```

---

## 安全考虑

1. **Token 安全存储**
   - 后端使用 bcrypt 哈希存储
   - 仅创建时返回完整 Token
   - 列表 API 仅返回脱敏版本

2. **Token 脱敏展示**
   - 列表中始终脱敏显示
   - 脱敏格式：`tk-前6位****后4位`
   - 不提供查看完整 Token 的接口

3. **一次性显示**
   - 创建成功后立即显示完整 Token
   - 用户关闭对话框后无法再次查看
   - 强烈建议用户立即保存

4. **复制功能**
   - 使用现代 Clipboard API
   - 复制成功后清空剪贴板历史 (可选)
   - 提示用户妥善保管

---

## 相关文档

- [PRD - Epic 7: Web 管理界面](../prd.md#epic-7-web-管理界面-fr20-fr24-fr6)
- [Story 7.1 - 搭建 Astro + React 项目](./7.1.story.md)
- [Story 6.1 - Token 生成和存储](./6.1.story.md)
- [Story 6.2 - Token 验证中间件](./6.2.story.md)
- [API 文档 - Token Endpoints](../api/openapi.yaml)
